<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ask Mr Lin</title>
    <link
      href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Poppins", sans-serif;
        background-color: #f4f4f4;
        margin: 0;
        padding: 0;
      }

      h4#refinementTypeTitle {
        color: #0d603a;
      }
      h1,
      h4 {
        color: #333;
      }

      h4#inputHeader {
        color: #007bff;
      }

      h4#outputHeader {
        color: #ff5733;
      }
      .select-focus {
  color: #16b816; /* Light green color */
}
      .container {
        padding: 2% 3%;
        max-width: 100%;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .limited-textarea {
        border: 1px solid #e0e0e0;
        transition: border 0.3s ease;
        resize: none;
        max-height: calc(1.5em * 17);
        overflow-y: auto; /* Add scrollbar when exceeding 18 lines */
      }


      textarea {
        border: 1px solid #e0e0e0;
        transition: border 0.3s ease;
        resize: none;
        min-height: 150px;
        padding: 10px;
      }

      textarea:focus {
        border: 1px solid #007bff;
        box-shadow: none;
      }

      .btn {
        margin-top: 10px;
      }

      .word-count {
        font-size: 0.9em;
        color: #888;
        margin-top: 5px;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <h1 class="text-center mb-3">Ask Mr Lin </h1>

      <div class="form-group">
        <h4 id="refinementTypeTitle">Select Your Question Type</h4>

        <select id="refinementType" class="form-control" onchange="handleSelectChange(this)">
          <option value="grammar">Help me correct my grammar</option>
          <option value="translation">English/Chinese Translation</option>
          <option value="asking">Ask Mr Lin Anything</option>
        </select>
      </div>
      <div class="row mb-3">
        <div class="col-md-6">
          <h4 id="inputHeader">Input</h4>
          <textarea
            id="inputText"
            class="form-control limited-textarea"
            placeholder="Enter your text/question here..."
            oninput="adjustHeight(this); updateWordCount('input')"
          ></textarea>
          <div class="word-count" id="inputWordCount">Word count: 0</div>
        </div>
        <div class="col-md-6">
          <h4 id="outputHeader">Output <span id="generatingText" style="display: none;">Generating...</span></h4>

          <textarea
            id="correctedText"
            class="form-control limited-textarea"
            readonly
            placeholder="Response will appear here..."
            oninput="adjustHeight(this); updateWordCount('output')"
          ></textarea>
          <div class="word-count" id="outputWordCount">Word count: 0</div>
        </div>
      </div>

      <div class="row">
        <div class="col-md-6 text-center">
          <button onclick="correctGrammar()" class="btn btn-primary">
            Enter
          </button>
        </div>
        <div class="col-md-6 text-center">
          <button onclick="clearOutput()" class="btn btn-danger">
            Clear Output
          </button>
        </div>
      </div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <script>
      // async function correctGrammar() {
      //   const text = document.getElementById("inputText").value;
      //   const refinementType = document.getElementById("refinementType").value;

      //   const response = await fetch("/correct", {
      //     method: "POST",
      //     headers: {
      //       "Content-Type": "application/json",
      //     },
      //     body: JSON.stringify({ text: text, refinementType: refinementType }),
      //   });

      //   const data = await response.json();
      //   const correctedTextArea = document.getElementById("correctedText");
      //   correctedTextArea.value = data.corrected_text;
      //   adjustHeight(correctedTextArea);
      //   updateWordCount("output");
      // }

      async function correctGrammar() {
      showGeneratingText(); // Show "Generating..." text

      const text = document.getElementById("inputText").value;
      const refinementType = document.getElementById("refinementType").value;

      try {
          const response = await fetch("/correct", {
            method: "POST",
            headers: {
               "Content-Type": "application/json",
            },
            body: JSON.stringify({ text: text, refinementType: refinementType }),
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();
          const correctedTextArea = document.getElementById("correctedText");
          correctedTextArea.value = data.corrected_text;
          adjustHeight(correctedTextArea);
          updateWordCount("output");
      } catch (error) {
         console.error('Error fetching the corrected text:', error);
        } finally {
         hideGeneratingText(); // Hide "Generating..." text regardless of success or failure
        }
      }

   function showGeneratingText() {
      document.getElementById("generatingText").style.display = 'inline'; // Show "Generating..."
   }

   function hideGeneratingText() {
      document.getElementById("generatingText").style.display = 'none'; // Hide "Generating..."
   }




      function adjustHeight(textarea) {
        textarea.style.height = "auto";
        let scrollHeight = textarea.scrollHeight;
        let maxHeight = parseFloat(getComputedStyle(textarea).maxHeight);
        if (scrollHeight > maxHeight) {
          textarea.style.height = `${maxHeight}px`;
        } else {
          textarea.style.height = `${scrollHeight}px`;
        }
      }

      function clearOutput() {
        const correctedTextArea = document.getElementById("correctedText");
        correctedTextArea.value = "";
        adjustHeight(correctedTextArea);
        updateWordCount("output");
      }

      // function updateWordCount(type) {
      //   let textarea =
      //     type === "input"
      //       ? document.getElementById("inputText")
      //       : document.getElementById("correctedText");
      //   let wordCountDisplay =
      //     type === "input"
      //       ? document.getElementById("inputWordCount")
      //       : document.getElementById("outputWordCount");
      //   let wordCount = textarea.value.split(/\s+/).filter(Boolean).length;
      //   wordCountDisplay.textContent = `Word count: ${wordCount}`;
      // }

      function updateWordCount(type) {
        let textarea =
          type === "input"
            ? document.getElementById("inputText")
            : document.getElementById("correctedText");
        let wordCountDisplay =
          type === "input"
            ? document.getElementById("inputWordCount")
            : document.getElementById("outputWordCount");

        let text = textarea.value;
        let count;

        // Check if the text contains Chinese characters
        if (/[\u4e00-\u9fff]/.test(text)) {
          // Count characters for Chinese
          count = (text.match(/[\u4e00-\u9fff]/g) || []).length;
              // Manually exclude common Chinese punctuation
          const punctuation = /[\u3000-\u303f\uff00-\uffef]/g; // This range includes common Chinese punctuations
          const punctuationCount = (text.match(punctuation) || []).length;
          count -= punctuationCount;
        } else {
          // Count words for English and similar languages
          count = text.split(/\s+/).filter(Boolean).length;
        }

        wordCountDisplay.textContent = `Word count: ${count}`;
      }

      function handleSelectChange(selectElement) {
        if (selectElement.value !== '') {
          selectElement.classList.add('select-focus');
        } else {
          selectElement.classList.remove('select-focus');
        }
      }

    </script>
  </body>
</html>
